# TODO: Доработки по пункту 1 (БД / Партиционирование / Миграции)

Статус: Alembic scaffold создан (env.py, alembic.ini). Осталось довести до 100%:

## 1. Переписать 005_partitioning.sql
Текущая стратегия делает RENAME + COPY данных (INSERT SELECT) -> риск блокировок. План:
1. Создать новые временные партиционированные таблицы raw_signals_p / features_p (PARTITION BY RANGE).
2. Создать партиции за нужный диапазон (±12 месяцев) без копирования.
3. ATTACH EXISTING: если данных много, рассмотреть pg_repack/pg_redefine для онлайнового перехода.
4. Переименовать старые таблицы в *_legacy и новые в боевые. При успешной валидации (counts match) — удалить legacy.

## 2. Baseline ревизия Alembic
Автогенерация: `alembic revision --autogenerate -m "baseline"` (после согласования окончательной схемы) и фиксация в VCS.

## 3. Дополнительные индексы
- Рассмотреть составной индекс на predictions (equipment_id, created_at) если появятся частые срезы по времени.
- Проверить наличие индекса по feature.window_start (уже есть idx_features_window_start). Возможно добавить (equipment_id, window_start) через join path.

## 4. Производительный тест
Скрипт (позже в разделе тестов) для измерения:
- Скорость bulk INSERT до и после партиционирования.
- План запросов EXPLAIN ANALYZE по типовым выборкам (последние 168 часов RMS).

## 5. Документация rollback
Описать: как вернуть непартиционированные таблицы (создать временную, INSERT SELECT, swap rename).

## 6. Retention
Связано с пунктом 17 — добавить таблицу/задачу retention для raw_signals > N дней.

---
Файл служит напоминанием. Закрыть после выполнения всех подпунктов и обновления README.
