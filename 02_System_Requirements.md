# SRS — Системные требования (DiagMod)

Версия: 1.1 • Дата: 2025‑08‑25 • Автор: системный аналитик • Статус: рабочий

## Оглавление
- Область и цели
- Термины/глоссарий
- Акторы и интерфейсы
- Функциональные требования (FR‑X)
- Нефункциональные требования (NFR‑X)
- Архитектура и данные
- Параллелизм/идемпотентность
- Конфигурация и деплой
- Наблюдаемость и эксплуатация
- Приёмка и трассируемость

## Область и цели
Система для приема токовых сигналов, извлечения признаков, детекции аномалий и визуализации. Целевая среда: Windows/Ubuntu, PostgreSQL, Python 3.11+.

## Термины/глоссарий
RawSignal — сырые сигналы; Feature — признаки; HourlyFeatureSummary — почасовые агрегаты; AnomalyScore — оценки аномальности; Equipment — объект диагностики.

## Акторы и интерфейсы
- Пользовательский интерфейс: Streamlit‑дашборд.
- Системный интерфейс: FastAPI REST (JSON), эндпойнты /health, /metrics, /signals, /upload.
- Мониторинг: Prometheus‑метрики.

## Функциональные требования
- FR‑1. Импорт CSV (R/S/T, частота, метаданные), строгая валидация заголовка/данных.
- FR‑2. Дедупликация по `file_hash` (уникальный индекс); для батчей — `meta.batch_index`.
- FR‑3. Обработка: валидация → признаки → аномалии → прогноз → статусы.
- FR‑4. Идемпотентность: отсутствие дублей Feature (ключ `(raw_id, window_start)`), корректные статусы RawSignal.
- FR‑5. Конкурентная обработка с исключением гонок (CLAIM/блокировки).
- FR‑6. API: загрузка, фильтрация сигналов, получение статусов/признаков/аномалий.
- FR‑7. Экспорт отчётов и выгрузок по фильтрам.
- FR‑8. Миграции схемы Alembic (создание/изменение таблиц и индексов).

## Нефункциональные требования
- NFR‑1. Производительность: файл до ~1.5 млн точек/фаза ≤ 10 минут на референс‑сервере; 1000 сигналов ≤ согласованного SLA.
- NFR‑2. Масштабирование: горизонтально за счёт нескольких инстансов обработки.
- NFR‑3. Надёжность: повторные запуски безопасны (идемпотентность).
- NFR‑4. Доступность: API/дашборд ≥ 99% (9×5).
- NFR‑5. Безопасность: авторизация JWT для чувствительных операций; секреты вне кода.
- NFR‑6. Наблюдаемость: структурированные логи, метрики Prometheus, health‑пробы.
- NFR‑7. Совместимость: Windows/Ubuntu, локальный запуск без Docker обязателен.

## Архитектура и данные
- БД: PostgreSQL. Индексы: `raw_signals(processing_status, created_at)`, уникальность: `raw_signals(file_hash)`.
- Схема: хранение фаз в сжатом бинарном виде float32; фичи как числовые поля; агрегаты по часам.
- Retention: очищать бинарные фазы по флагу `RETAIN_RAW_SIGNALS`.

## Параллелизм/идемпотентность
- Отбор: `processing_status != COMPLETED` с батч‑лимитом.
- CLAIM‑стратегии: `UPDATE ... WHERE processing_status='pending' RETURNING id` или `SELECT ... FOR UPDATE SKIP LOCKED`.
- Идемпотентность: проверка Feature по `(raw_id, window_start)`; приведение Decimal→float в агрегатах; статусы PENDING→PROCESSING→COMPLETED/FAILED.

## Конфигурация и деплой
- .env через pydantic‑settings: `DATABASE_URL`, `APP_ENVIRONMENT`, уровни логирования.
- Миграции: `alembic upgrade head`.
- Пулы подключений: `DATABASE_POOL_SIZE=10`, `DATABASE_MAX_OVERFLOW=20` (по умолчанию; настраиваемо).
- Совместимость Linux: скрипт `scripts/setup.sh` создаёт `APP_ENVIRONMENT`, БД инициализируется через Alembic.

## Наблюдаемость и эксплуатация
- `/health` — статус БД; `/metrics` — метрики Prometheus.
- Логи: SQLAlchemy.engine на WARNING, приложение — INFO/DEBUG по настройке.
- Скрипты статуса/проверок: `scripts/status.ps1` (Windows), make‑цели.

## Приёмка и трассируемость
Критерии приёмки:
- Обработка тестового набора CSV без дублей `file_hash`/Feature.
- Параллельная обработка 2 инстансами без гонок и дублей.
- API/дашборд доступны; метрики и health в норме.
- `alembic upgrade head` на чистой БД проходит без ошибок.

Матрица трассируемости (фрагмент):
- BT‑1 → FR‑2; BT‑3 → FR‑4/FR‑5; BT‑4 → FR‑5; BT‑5 → NFR‑1; BT‑6 → NFR‑4.
